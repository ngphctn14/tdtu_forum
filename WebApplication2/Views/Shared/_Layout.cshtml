<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>@ViewBag.Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="title" content="Ask online Form">
    <meta name="description" content="The Ask is a bootstrap design help desk, support forum website template coded and designed with bootstrap Design, Bootstrap, HTML5 and CSS. Ask ideal for wiki sites, knowledge base sites, support forum sites">
    <meta name="keywords" content="HTML, CSS, JavaScript,Bootstrap,js,Forum,webstagram ,webdesign ,website ,web ,webdesigner ,webdevelopment">
    <meta name="robots" content="index, nofollow">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="language" content="English">
    <meta name="viewport" content="width=device-width" />
    <link href="~/Content/css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="~/Content/css/style.css" rel="stylesheet" type="text/css">
    <link href="~/Content/css/editor.css" rel="stylesheet" type="text/css">
    <link href="css/animate.css" rel="stylesheet" type="text/css">
    <link href="~/Content/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="~/Content/css/responsive.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="~/Content/css/loginstyle.css">
    <link rel="stylesheet" href="~/Scripts/ckeditor5/ckeditor5.css" />
    <style>
        .user-info-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-image2934 img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-username {
            color: #333;
            line-height: normal;
        }

        .post-content img {
            max-width: 100%;
            height: auto;
            display: block; /* Prevents potential layout issues */
        }
    </style>
</head>

<body>
    <!--======== Navbar =======-->
    <div class="top-bar">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="navbar-menu-left-side239">
                        <ul>
                            <li><a href="@Url.Action("Index", "Contact")"><i class="fa fa-envelope-o" aria-hidden="true"></i>Contact</a></li>
                            @if (Session["Username"] != null)
                            {
                                <li><a href="@Url.Action("UserInfo", "User", new {id = Session["Id"] })"><i class="fa fa-user" aria-hidden="true"></i>Hello, @Session["Username"]</a></li>
                                <li></li>
                                <li></li>
                                <li>|</li>
                                <li></li>
                                <li><a href="@Url.Action("Logout", "Login")"><i class="fa fa-arrow-circle-o-left" aria-hidden="true"></i>Logout</a></li>
                            }
                            else
                            {
                                <li><a href="@Url.Action("Index", "Login")"><i class="fa fa-user" aria-hidden="true"></i>Login</a></li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="navbar-serch-right-side">
                        <div class="text-center">
                            <form class="navbar-form" role="search">
                                <div class="input-group add-on">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ==========header mega navbar=======-->
    <div class="top-menu-bottom932">
        <nav class="navbar navbar-default">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
                    <a class="navbar-brand" href="@Url.Action("Index", "Home")"><img src="~/Content/image/logo1.png" alt="Logo" style="width: 100px; height: 100px"></a>
                    <a href="@Url.Action("Index", "Home")" style="font-weight: 700;color: #DE0405;font-family: 'Nunito',sans-serif;font-size: 18.5px; display:inline-block; margin-top:10px">FACULTY OF INFORMATION</a>
                </div>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav"> </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="@Url.Action("Index", "Home")">Home</a></li>
                        @if (Session["Username"] != null)
                        {
                            <li><a href="@Url.Action("Index", "Post")">New Post</a></li>
                        }
                        else
                        {
                            <li><a href="@Url.Action("Index", "Login")">New Post</a></li>
                        }
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Categories <span class="caret"></span></a>
                            <ul class="dropdown-menu animated zoomIn">
                                @{Html.RenderAction("getDetails", "Category");}
                            </ul>
                        </li>
                        <li><a href="@Url.Action("allUsers", "User")">Users</a></li>
                        <li><a href="@Url.Action("Index", "Contact")">Contact Us</a></li>
                    </ul>
                </div>
                <!-- /.navbar-collapse -\ijkk->
                </div>
                <!-- /.container-fluid -->
        </nav>
    </div>

    @RenderBody()

    <!--    footer -->
    <div class="footer-search">
    </div>
    <section class="footer-social">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>Copyright 2024 Đại học Tôn Đức Thắng | <strong>Ngô Phúc Tấn, Lê Hoàng</strong></p>

                </div>
                <div class="col-md-6">
                    <div class="social-right2389"> <a href="https://www.facebook.com/tonducthanguniversity" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>  <a href="https://www.youtube.com/TDTUChannel" target="_blank"><i class="fa fa-youtube" aria-hidden="true"></i></a> </div>
                </div>
            </div>
        </div>
    </section>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script>
    <script src="~/Scripts/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/&#64;popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/Scripts/js/npm.js"></script>
    <script src="~/Scripts/js/editor.js"></script>
    <script src="~/Scripts/ckeditor5/ckeditor5.umd.js"></script>
    <script>
        const {
            ClassicEditor,
            Essentials,
            Bold,
            Italic,
            Font,
            Paragraph,
            PasteFromOffice,
            Image,
            ImageInsert,
            ImageUpload
        } = CKEDITOR;

        class MyUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file
                    .then(file => {
                        return new Promise((resolve, reject) => {
                            const formData = new FormData();
                            formData.append('file', file);

                            fetch('/Post/UploadImage', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => {
                                if (!response.ok) { // Check for HTTP errors (e.g., 400, 500)
                                    return response.json().then(err => { throw err; }); // Reject with the error message
                                }
                                return response.json();  // Parse the JSON response
                            })
                            .then(result => {
                                 if (result.uploaded == 1) { // Check the uploaded status
                                    resolve({ default: result.url });
                                } else {
                                    reject(result.error.message); // Reject with error message
                                }
                            })
                            .catch(error => {
                                reject(error.message ? error.message : "Image upload failed."); // Handle and reject any errors
                            });
                        });
                    });
            }

            abort() {
            }
        }

        // Upload adapter plugin
        function MyUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new MyUploadAdapter(loader);
            };
        }

        ClassicEditor
            .create(document.querySelector('#editor'), {
                plugins: [
                    Essentials, 
                    Bold, 
                    Italic, 
                    Font, 
                    Paragraph, 
                    PasteFromOffice, 
                    Image, 
                    ImageInsert, 
                    ImageUpload,
                    MyUploadAdapterPlugin  // Add this plugin
                ],
                toolbar: [
                    'undo', 'redo', '|', 'bold', 'italic', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', 'insertImage'
                ]
            })
            .then(newEditor => {
                let editor = newEditor;
                const form = document.getElementById('post-form');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        const editorContent = editor.getData().trim();
                        if (!editorContent || editorContent === '<p></p>' || editorContent === '<p>&nbsp;</p>') {
                            e.preventDefault();
                            document.getElementById('comment-error').style.display = 'block';
                            return false;
                        }
                        document.getElementById('comment-error').style.display = 'none';
                        document.querySelector('#editor').value = editorContent;
                    });
                }
            })
            .catch(error => {
                console.error(error);
            });

        ClassicEditor
            .create(document.querySelector('#comment-editor'), {
                plugins: [Essentials, Bold, Italic, Font, Paragraph],
                toolbar: [
                    'undo', 'redo', '|', 'bold', 'italic', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor'
                ]
            })
            .then(newEditor => {
                let editor = newEditor;

                const form = document.getElementById('post-comment-form');
                if (form) {
                    form.addEventListener('submit', function (e) {
                        const editorContent = editor.getData().trim();

                        if (!editorContent || editorContent === '<p></p>' || editorContent === '<p>&nbsp;</p>') {
                            e.preventDefault();
                            document.getElementById('comment-error').style.display = 'block';
                            return false;
                        }

                        document.getElementById('comment-error').style.display = 'none';
                        document.querySelector('#comment-editor').value = editorContent;
                    });
                }
            })
            .catch(error => {
                console.error('Editor error:', error);
            });

        ClassicEditor
            .create(document.querySelector('#feedback-editor'), {
                plugins: [Essentials, Bold, Italic, Font, Paragraph],
                toolbar: [
                    'undo', 'redo', '|', 'bold', 'italic', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor'
                ]
            })
            .then(newEditor => {
                //    let editor = newEditor;

                //    const form = document.getElementById('post-comment-form');
                //    if (form) {
                //        form.addEventListener('submit', function (e) {
                //            const editorContent = editor.getData().trim();

                //            if (!editorContent || editorContent === '<p></p>' || editorContent === '<p>&nbsp;</p>') {
                //                e.preventDefault();
                //                document.getElementById('comment-error').style.display = 'block';
                //                return false;
                //            }

                //            document.getElementById('comment-error').style.display = 'none';
                //            document.querySelector('#comment-editor').value = editorContent;
                //        });
                //    }
            })
            .catch(error => {
                console.error('Editor error:', error);
            });
    </script>
    <script>
        (function($){
            $('.likeBtn').click(function () {
                var userId = @Session["Id"]+"";
                var url = $(this).data('url');
                var postId = $(this).data('id');
                var $likeButton = $(this);
                var $likeCountSpan = $likeButton.siblings('.single-question-vote-result');

                if (userId === 0) {
                    alert("You must log in to like post.");
                    return;
                }

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        post_id: postId
                    },
                    success: function (result) {
                        if (result.success) {
                            $likeCountSpan.text(result.likeCount + ' Likes');

                            if (result.isLiked) {
                                $likeButton.removeClass('fa-thumbs-o-up').addClass('fa-thumbs-up');
                            } else {
                                $likeButton.removeClass('fa-thumbs-up').addClass('fa-thumbs-o-up');
                            }
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', xhr.responseText);
                        alert('An error occurred while processing your like.');
                    }
                });
            });

            $('.commentLikeBtn').click(function () {
                var userId = @Session["Id"]+"";
                var url = $(this).data('url');
                var commentId = $(this).data('id');
                var $likeButton = $(this);
                var $likeCountSpan = $likeButton.siblings('.comment-like-result');

                if (userId === 0) {
                    alert("You must log in to like comment.");
                    return;
                }

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        comment_id: commentId
                    },
                    success: function (result) {
                        if (result.success) {
                            $likeCountSpan.text(result.likeCount + ' Likes');
                            if (result.isLiked) {
                                $likeButton.removeClass('fa-thumbs-o-up').addClass('fa-thumbs-up');
                            } else {
                                $likeButton.removeClass('fa-thumbs-up').addClass('fa-thumbs-o-up');
                            }
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', xhr.responseText);
                        alert('An error occurred while processing your like.');
                    }
                });
            });

            $('#followUnfollowLink').click(function () {
                var userId = $(this).data('user-id');
                var action = $(this).text().trim().toLowerCase();

                if (@Session["Id"] === 0) {
                    alert("You must log in to follow/unfollow user.");
                    return;
                }

                console.log(userId)
                console.log(action)

                $.ajax({
                    url: '@Url.Action("ToggleFollow", "User")',
                    type: 'POST',
                    data: {
                        userId: userId,
                        action: action
                    },
                    success: function (response) {
                        if (response.success) {
                            followUnfollowLink.textContent = response.isFollowing ? 'Unfollow' : 'Follow';
                            document.querySelector('[data-target="#followersModal"]').textContent = response.followersCount + ' Followers';
                        }                        },
                    error: function () {
                        alert('Error toggling follow status');
                    }
                });
            });

            const form = document.getElementById('changePasswordForm');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

            const currentPasswordError = document.getElementById('currentPasswordError');
            const newPasswordError = document.getElementById('newPasswordError');
            const confirmNewPasswordError = document.getElementById('confirmNewPasswordError');

            form.addEventListener('submit', function (e) {
                currentPasswordError.textContent = '';
                newPasswordError.textContent = '';
                confirmNewPasswordError.textContent = '';

                let isValid = true;

                // Validate current password (this would typically involve an AJAX call)
                if (currentPasswordInput.value.trim() === '') {
                    currentPasswordError.textContent = 'Please enter your current password';
                    isValid = false;
                }

                // Validate new password
                if (newPasswordInput.value.length < 8) {
                    newPasswordError.textContent = 'New password must be at least 8 characters long';
                    isValid = false;
                }

                // Validate password match
                if (newPasswordInput.value !== confirmNewPasswordInput.value) {
                    confirmNewPasswordError.textContent = 'Passwords do not match';
                    isValid = false;
                }

                if (isValid) {
                    $.ajax({
                        url: '@Url.Action("VerifyCurrentPassword", "User")',
                        type: 'POST',
                        data: {
                            currentPassword: currentPasswordInput.value
                        },
                        success: function (response) {
                            if (!response.isValid) {
                                e.preventDefault();
                                currentPasswordError.textContent = 'Current password is incorrect';
                            }
                        },
                        error: function () {
                            currentPasswordError.textContent = 'Error verifying password';
                            e.preventDefault();
                        }
                    });
                } else {
                    e.preventDefault();
                }
            });

            // Optional: Real-time validation as user types
            newPasswordInput.addEventListener('input', function () {
                if (this.value.length < 8) {
                    newPasswordError.textContent = 'Password must be at least 8 characters long';
                } else {
                    newPasswordError.textContent = '';
                }
            });

            confirmNewPasswordInput.addEventListener('input', function () {
                if (this.value !== newPasswordInput.value) {
                    confirmNewPasswordError.textContent = 'Passwords do not match';
                } else {
                    confirmNewPasswordError.textContent = '';
                }
            });

            $("#editUserDetailsForm").validate({
                rules: {
                    full_name: {
                        required: true,
                        minlength: 2
                    },
                    email: {
                        required: true,
                        email: true
                    }
                },
                messages: {
                    full_name: {
                        required: "Please enter your full name",
                        minlength: "Name must be at least 2 characters long"
                    },
                    email: {
                        required: "Please enter your email address",
                        email: "Please enter a valid email address"
                    }
                },
                submitHandler: function (form) {
                    form.submit();
                }
            });
         })(jQuery);
    </script>

</body>

